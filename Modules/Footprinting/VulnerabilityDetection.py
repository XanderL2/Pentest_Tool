import nmap, re;






def DetectVulnerabilities(ip):

    nm = nmap.PortScanner()


    arguments = '-p- -sVC -sC --open -sS -n -Pn'


    # Realizar el escaneo
    nm.scan(hosts=ip, arguments=arguments, sudo=True)




    # Verificar si el device está en el resultado del escaneo
    if ip in nm.all_hosts():


        device= {
            "EstadoDeHost": nm[ip].state(),
            "PuertosYVersiones": [],
            "Vulnerabilidades": []
        }


        # Obtener la información de los puertos TCP
        tcpPorts = nm[ip]['tcp']




        # Iterar sobre los puertos TCP
        for ports, info_puerto in tcpPorts.items():

            # Si el portsestá abierto, agregarlo a la lista de Puertos y Versiones
            if info_puerto['state'] == 'open':
                device["PuertosYVersiones"].append({
                    "Puerto": ports,
                    "Version": info_puerto.get("version", "Desconocida")
                })



            # Obtener los scripts asociados con elports 
            scripts = info_puerto.get("script", {})



            # Iterar sobre los scripts y buscar vulnerabilidades
            for nombre_script, info_script in scripts.items():


                # Si el script indica una vulnerabilidad, agregarla a la lista de Vulnerabilidades
                if "VULNERABLE" in info_script:
                    cve_ids = set(re.findall(r"CVE-\d+-\d+", info_script))
                    device["Vulnerabilidades"].append({
                        "Puerto": ports,
                        "VulnerabilidadID": cve_ids
                    });


        return device 

    else:
        return None

# DetectVulnerabilities("192.168.1.68")











