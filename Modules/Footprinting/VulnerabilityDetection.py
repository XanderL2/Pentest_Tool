import nmap, re; 

def DetectVulnerabilities(ip):


    nm = nmap.PortScanner()
    command = f"sudo nmap -p- -sVC -sC --open -sS -vvv -n -Pn {ip}";

    print(command)

    device= {}


    # Lanzamos el escaneo
    nm.scan(hosts=ip, arguments=command, sudo=True)
    


    # Estado del dispositivo
    if(ip in nm._scan_result["scan"]):
        
        device.update({"Estado de Host": nm[ip].state(), "Puertos Abiertos": nm[ip].all_tcp(), "Puertos y Versiones": [], "Vulnerabilidades": []})

        

        #Iteraremos sobre los puertos TCP
        for port, portInfo in (nm[ip]["tcp"].items()):
            
            #Si los puertos estan abiertos los agrupamos en un objeto, por version y por puerto:
            if(portInfo.get("state") == "open"):
                device["Puertos y Versiones"].append({"Puerto": port, "Version": portInfo.get("version")})
            
            
            #Obtendremos los scripts disponibles para cada puerto
            scripts = portInfo.get("script")
            

            #Si ese obtiene la clave Script entonces

            if (scripts):
                for script_nombre, script_info in (scripts.items()):

                    #Iteraremos sobre cada cada clave y valor en el objeto script  
                    if ("VULNERABLE" in script_info):
                        
                        device["Vulnerabilidades"].append({"Puerto": port, "Vulnerabilidad ID": set(re.findall(r"CVE\-\d*\-\d*", script_info))})

                        
                        
        print(device)
        return device; 
       
        
    else:
        return None; 

# DetectVulnerabilities("192.168.1.68")











